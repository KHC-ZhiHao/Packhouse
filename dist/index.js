!function(t,s){"undefined"!=typeof module&&"object"==typeof exports?module.exports=s():"function"==typeof define&&(define.amd||define.cmd)?define(function(){return s}):t.Packhouse=s()}(this||("undefined"!=typeof window?window:global),function(){class t{static getArgsLength(t){for(var s=t.toString(),e=0,i=0,r=0,o=!1,n=!1,a=0;a<s.length;a++)if(!["(","[","{"].includes(s[a])||o||n){if(![")","]","}"].includes(s[a])||o||n)"'"!==s[a]||n||"\\"===s[a-1]?'"'!==s[a]||o||"\\"===s[a-1]?","!==s[a]||1!==i||o||n||e++:n=!n:o=!o;else if(--i<1)break}else i++,r=a;return 0===e&&0===s.substring(r+1,a).trim().length?0:e+1}}class s{}class e{constructor(t){this.$moduleBase={name:t||"no name"}}$systemError(t,s,e="$_no_error"){throw"$_no_error"!==e&&console.log("error data => ",e),new Error(`(☉д⊙)!! PackHouse::${this.$moduleBase.name} => ${t} -> ${s}`)}$noKey(t,s,e){return null==s[e]||(this.$systemError(t,`Name(${e}) already exists.`),!1)}$verify(t,s,e={}){let i={};for(let e in s){let r=s[e],o=r[0],n=r[1],a=r[2];o&&null==t[e]&&this.$systemError("verify",`Key(${e}) is required`),n&&null!=t[e]&&!n.includes(typeof t[e])&&this.$systemError("verify",`Type(${e}::${typeof t[e]}) error, need ${n.join(" or ")}`),i[e]=t[e]||a}return Object.assign(i,e)}$protection(t){return new Proxy(t,{set:(t,s)=>this.$systemError("$protection",`Key(${s}) is protection`,t)})}}class i extends e{constructor(t={}){super("Packhouse"),this.groups={},this.bridge=null,t.bridge&&this.setBridge(t.bridge)}static createPublicMold(t){let s=new m(t);if(f[s.name])throw new Error(`(☉д⊙)!! PackHouse::createPublicMold -> Public mold name(${s.name}) already exists.`);f[s.name]=s}static createOrder(t){let s=new r(t);return new $(s)}static createGroup(t){let s=new y(t);return new x(s)}static createFactory(t){let s=new i(t);return new b(s)}static isFactory(t){return t instanceof i||t instanceof b}static isGroup(t){return y.isGroup(t)}static asyncLoop(t,s,e){if(!1===Array.isArray(t))return void e("AsyncLoop : Targrt not be array.");if("function"!=typeof s||"function"!=typeof e)return void e("AsyncLoop : Action or callback not a function.");let i=t.length,r=0,o=()=>{(r+=1)===i&&e()},n=async(t,e)=>{s(t,e,o)};for(let s=0;s<i;s++)n(t[s],s);0===i&&e()}getGroup(t){if(this.hasGroup(t))return this.groups[t];this.$systemError("getGroup",`Group(${t}) not found.`)}getTool(t,s){return this.getGroup(t).callTool(s)}getLine(t,s){return this.getGroup(t).callLine(s)}addGroup(t,s,e){null==this.groups[t]?!1!==y.isGroup(s)?(s.create(e),this.groups[t]=s):this.$systemError("addGroup","Must group.",s):this.$systemError("addGroup",`Name(${t}) already exists.`)}hasGroup(t){return!!this.groups[t]}hasTool(t,s){return!!this.getGroup(t).hasTool(s)}hasLine(t,s){return!!this.getGroup(t).hasLine(s)}tool(t,s){return this.callBridge(t,s),this.getTool(t,s)}line(t,s){return this.callBridge(t,s),this.getLine(t,s)}callBridge(t,s){this.bridge&&this.bridge(this,t,s)}setBridge(t){"function"==typeof t?this.bridge=t:this.$systemError("setBridge","Bridge not a function.",t)}}class r extends e{constructor(t={}){super("Order"),this.init(),this.options=this.$verify(t,{max:[!1,["number"],1e3]})}init(){this.keys=[],this.caches={},this.length=0}has(t){if("string"==typeof t)return!!this.caches[t];this.$systemError("has","Key not a string.",t)}get(t){if(this.has(t))return this.caches[t].exports;this.$system("get",`Key(${t}) not found.`)}list(){let t={};for(let s of this.caches)t[s]=this.caches[s].result;return t}clear(){this.init()}create(t){return this.length+=1,this.keys.push(t),this.caches[t]=new o,this.length>this.options.max&&this.remove(this.keys[0]),this.get(t)}remove(t){this.has(t)?(this.length-=1,delete this.caches[this.keys.shift()]):this.$systemError("remove",`Key(${t}) not found.`)}getOrCreate(t){return this.has(t)?this.get(t):this.create(t)}}class o extends e{constructor(){super("OrderCache"),this.mode=null,this.ready=!1,this.loaded=!1,this.onloadBuffers=[],this.result=null,this.buffers=[],this.exports={post:this.post.bind(this),buffer:this.buffer.bind(this),onload:this.onload.bind(this),isReady:this.isReady.bind(this),onReady:this.onReady.bind(this)}}post(){for(;this.buffers.length>0;){let t=this.buffers.pop();"success"===this.mode?t.success(this.result):t.error(this.result)}}buffer(t,s){return this.buffers.push({error:t,success:s}),this.exports}isReady(){return!!this.ready}onReady(t){!1===this.isReady()&&(this.ready=!0,t(this.setError.bind(this),this.setSuccess.bind(this)))}onload(t){return this.loaded?t(this.exports):this.onloadBuffers.push(t),this.exports}postOnload(){for(;this.onloadBuffers.length>0;){this.onloadBuffers.pop()(this.exports)}}set(t,s){!1===this.loaded&&(this.mode=t,this.loaded=!0,this.result=s,this.postOnload())}setError(t){this.set("error",t)}setSuccess(t){this.set("success",t)}}class n{constructor(t,s){this.sop=s.sop,this.over=!1,this.group=t,this.welds=null,this.exports={error:this.error.bind(this),success:this.success.bind(this)},s.welds.length>0&&(this.welds=s.welds),s.noGood&&(this.noGood=s.noGood.action,this.noGoodOptions=s.noGood.options)}getError(t){return t||"unknown error"}error(t){!1===this.over&&(this.over=!0,this.errorBase(t),this.callSop({result:t,success:!1}))}success(t){!1===this.over&&(this.over=!0,this.runWeld(t,t=>{this.successBase(t),this.callSop({result:t,success:!0})}))}runWeld(t,s){if(null==this.welds)return s(t),null;let e=this.welds.pop();if(e){let i=this.group.callTool(e.tool);e.packing(t,i.packing),i.ng(this.noGood,this.noGoodOptions).action(t=>{this.runWeld(t,s)})}else s(t)}callSop(t){this.sop&&this.sop(t)}}class a extends n{constructor(t,s){super(t,s),this.result=null}errorBase(t){if(!this.noGood)throw new Error(this.getError(t));this.noGood(this.getError(t))}successBase(t){this.result=t}}class h extends n{constructor(t,s,e){super(t,s),this.callback=e||function(){}}errorBase(t){let s=this.getError(t);this.noGood?this.noGood(s):this.callback(s,null)}successBase(t){this.noGood?this.callback(t):this.callback(null,t)}}class l extends n{constructor(t,s,e,i){super(t,s),this.resolve=e,this.reject=i}errorBase(t){let s=this.getError(t);this.noGood&&this.noGood(s),this.noGood&&this.noGoodOptions.resolve?this.resolve(s):this.reject(s)}successBase(t){this.resolve(t)}}class u extends e{constructor(){super("Support"),this.sop=null,this.welds=[],this.noGood=null,this.package=[],this.exports=null}createExports(t){return this.exports={...t,ng:this.setNoGood.bind(this),unNg:this.unNoGood.bind(this),sop:this.setSop.bind(this),rule:this.setRule.bind(this),unSop:this.unSop.bind(this),weld:this.addWeld.bind(this),clear:this.clear.bind(this),unWeld:this.unWeld.bind(this),packing:this.addPacking.bind(this),unPacking:this.unPacking.bind(this)},this.exports}copy(){return{sop:this.sop,welds:this.welds.slice(),noGood:this.noGood,package:this.package.slice()}}addWeld(t,s){return this.welds.push({tool:t,packing:s}),this.exports}unWeld(){return this.welds=[],this.exports}setRule(t,s,e){return t&&this.setNoGood(t,e),s&&this.setSop(s),this.exports}setNoGood(t,s={}){if("function"==typeof t)return this.noGood={action:t,options:this.$verify(s,{resolve:[!1,["boolean"],!1]})},this.exports;this.$systemError("setNG","NG param not a function.",t)}unNoGood(){return this.noGood=null,this.exports}setSop(t){if("function"==typeof t)return this.sop=t,this.exports;this.$systemError("setSOP","SOP param not a function.",t)}unSop(){return this.sop=null,this.exports}addPacking(){return this.package=this.package.concat([...arguments]),this.exports}unPacking(){return this.package=[],this.exports}clear(){return this.unNoGood(),this.unSop(),this.unWeld(),this.unPacking(),this.exports}}class c extends e{constructor(t={},e,i){super("Tool"),this.user=i||new s,this.store={},this.group=e,this.updateStamp=0,this.exportStore=this.group.data.secure?this.$protection(this.store):this.store,this.argumentLength="number"==typeof t.paramLength?t.paramLength:-1,this.data=this.$verify(t,{name:[!0,["string"]],molds:[!1,["object"],[]],create:[!1,["function"],function(){}],action:[!0,["function"]],update:[!1,["function"],function(){}],updateTime:[!1,["number"],-1],allowDirect:[!1,["boolean"],!0]})}get name(){return this.data.name}install(){this.initSystem(),this.initArgLength(),this.initCreate(),this.initCatchData(),this.updateStamp=Date.now(),this.install=null}initCatchData(){this.moldLength=this.data.molds.length}initCreate(){this.data.create.call(this.user,this.store,this.system)}checkUpdate(){Date.now()-this.updateStamp>this.data.updateTime&&this.update()}update(){this.install&&this.install(),this.data.update.call(this.user,this.store,this.system),this.updateStamp=Date.now()}updateCall(t){if(Array.isArray(t))for(let s of t)this.group.updateCall(s);else this.group.updateCall(t)}initSystem(){this.system={coop:this.coop.bind(this),tool:this.useTool.bind(this),line:this.useLine.bind(this),store:this.exportStore,group:this.group.exportCase,update:this.update.bind(this),include:this.useTool.bind(this),casting:this.casting.bind(this),updateCall:this.updateCall.bind(this)}}initArgLength(){-1===this.argumentLength&&(this.argumentLength=t.getArgsLength(this.data.action)-3),this.argumentLength<0&&this.$systemError("initArgLength","Args length < 0",this.name+`(length:${this.argumentLength})`)}createExports(){let t=new u,s={store:this.getStore.bind(this),direct:this.createLambda(this.direct,"direct",t),action:this.createLambda(this.action,"action",t),promise:this.createLambda(this.promise,"promise",t)};return t.createExports(s)}getError(t){return t||"unknown error"}createLambda(t,s,e){let i=Symbol(this.group.data.alias+"_"+this.name+"_"+s),r=t.bind(this),o=this.getActionCallback(s);return{[i]:(...t)=>{let s=e.copy(),i=new Array(this.argumentLength+3),n=this.argumentLength,a=o(t),h=s.package,l=h.length;for(let s=n;s--;)i[s]=s>=l?t[s-l]:h[s];return r(i,a,s)}}[i]}getActionCallback(t){return"action"===t?t=>{let s=t.pop();return"function"!=typeof s&&this.$systemError("createLambda","Action must a callback."),s}:function(){return null}}parseMold(t,s,e,i){let r=this.group.getMold(t),o=r.check(s,i);if(!0===o)return r.casting(s);"function"==typeof e?e(o):this.$systemError("parseMold",o)}casting(t,s,e){let i=t.split("|"),r=i.shift(),o=i,n=this.name;this.parseMold(r,s,e,{type:"system",index:0,extras:o,caller:n})}useTool(t){return this.group.callTool(t)}useLine(t){return this.group.callLine(t)}coop(t){return this.group.getMerger(t)}call(t,s,e){this.data.updateTime>=0&&this.checkUpdate();let i=this.moldLength;for(let e=0;e<i;e++){if(null==this.data.molds[e])continue;let i=this.data.molds[e].split("|"),r=i.shift();r&&(t[e]=this.parseMold(r,t[e],s,{type:"call",index:e,extras:i,caller:this.name}))}let r=t.length-3;t[r]=this.system,t[r+1]=s,t[r+2]=e,this.data.action.apply(this.user,t)}direct(t,s,e){!1===this.data.allowDirect&&this.$systemError("direct",`Tool(${this.data.name}) no allow direct.`),e.welds.length>0&&this.$systemError("direct",`Tool(${this.data.name}) use weld, can do direct.`);let i=new a(this.group,e);return this.call(t,i.exports.error,i.exports.success),i.result}action(t,s,e){let i=new h(this.group,e,s).exports;this.call(t,i.error,i.success)}promise(t,s,e){return new Promise((s,i)=>{let r=new l(this.group,e,s,i).exports;this.call(t,r.error,r.success)})}getStore(t){if(this.store[t])return this.store[t];this.$systemError("getStore",`Key(${t}) not found.`)}use(){return this.install&&this.install(),this.createExports()}}class d extends e{constructor(t,s){super("Line"),this.tools={},this.group=s,this.data=this.$verify(t,{name:[!0,["string"]],fail:[!0,["function"]],inlet:[!1,["object"],null],input:[!0,["object","function"]],output:[!0,["object","function"]],layout:[!0,["object"]]}),this.layoutKeys=Object.keys(this.data.layout),this.checkPrivateKey()}get name(){return this.data.name}checkPrivateKey(){let t=this.data.layout;(t.action||t.promise||t.setRule)&&this.$systemError("init","Layout has private key(action, promise, setRule)")}use(){return(...t)=>new p(this,t).conveyer}}class p extends e{constructor(t,e){super("Unit"),this.case=new s,this.flow=[],this.main=t,this.layout=t.data.layout,this.params=e,this.supports=new u,this.init()}createTool(t,s,e){return"function"==typeof s?new c({name:t,action:s},this.main.group,this.case).use():e?void this.$systemError("createTool",`${t} not a function.`):(s.name&&delete s.name,new c({name:t,...s},this.main.group,this.case).use())}init(){this.input=this.createTool("input",this.main.data.input),this.output=this.createTool("output",this.main.data.output,!0),this.initConveyer()}initConveyer(){this.conveyer={action:this.action.bind(this),promise:this.promise.bind(this),setRule:this.setRule.bind(this)};for(let t of this.main.layoutKeys)this.conveyer[t]=((...s)=>(this.register(t,s),this.conveyer))}register(t,s){let e=this.main.data.inlet;e&&0!==e.length&&0===this.flow.length&&!1===e.includes(t)&&this.$systemError("register",`First call method not inside inlet, you use '${t}'.`),this.flow.push({name:t,method:this.createTool(t,this.layout[t]),params:s})}action(t){let s=this.main.data.fail,e=this.supports.copy(),i=new h(this.main.group,e,t).exports;this.process(t=>s(t,i.error),i.success)}promise(){return new Promise((t,s)=>{let e=this.main.data.fail,i=this.supports.copy(),r=new l(this.main.group,i,t,s).exports;this.process(t=>e(t,r.error),r.success)})}setRule(...t){return this.supports.setRule(...t),this.conveyer}process(t,s){new g(this.params,this.flow,this.input,this.output).start(t,s)}}class g extends e{constructor(t,s,e,i){super("Process"),this.stop=!1,this.flow=s,this.index=0,this.stack=[],this.input=e,this.params=t,this.output=i}start(t,s){this.error=t,this.success=s,this.stack.push("input"),this.input.ng(this.fail).action(...this.params,this.next.bind(this))}finish(){this.stack.push("output"),this.output.ng(this.fail).action(this.success)}createError(t){return{message:t||"unknown error",stack:this.stack}}fail(t){!1===this.stop&&(this.stop=!0,this.error(this.createError(t)))}next(){if(!0===this.stop)return;let t=this.flow[this.index];t?(this.stack.push(t.name),t.method.ng(this.fail).action(...t.params,()=>{this.index+=1,this.next()})):this.finish()}}class m extends e{constructor(t={}){super("Mold"),this.case=new s,this.data=this.$verify(t,{name:[!0,["string"]],check:[!1,["function"],function(){return!0}],casting:[!1,["function"],function(t){return t}]})}get name(){return this.data.name}check(t,s){return this.data.check.call(this.case,t,s)}casting(t){return this.data.casting.call(this.case,t)}}let f={number:new m({name:"number",check:(t,s)=>null==t&&"abe"===s.extras[0]||("number"==typeof t||`Param ${s.index} not a number(${t}).`)}),int:new m({name:"int",check:t=>null==t&&"abe"===system.extras[0]||("number"==typeof t||`Param ${system.index} not a number(${t}).`),casting:t=>Math.floor(t)}),string:new m({name:"string",check:t=>null==t&&"abe"===system.extras[0]||("string"==typeof t||`Param ${system.index} not a string(${t}).`)}),array:new m({name:"array",check:t=>null==t&&"abe"===system.extras[0]||(!!Array.isArray(t)||`Param ${system.index} not a array(${t}).`)}),object:new m({name:"object",check:t=>null==t&&"abe"===system.extras[0]||("object"==typeof t||`Param ${system.index} not a object(${t}).`)}),function:new m({name:"function",check:t=>null==t&&"abe"===system.extras[0]||("function"==typeof t||`Param ${system.index} not a function(${t}).`)})};class y extends e{constructor(t={}){super("Group"),this.case=new s,this.data=this.$verify(t,{alias:[!1,["string"],"no_alias_group"],secure:[!1,["boolean"],!1],merger:[!1,["object"],{}],create:[!1,["function"],function(){}]}),this.linebox={},this.moldbox={},this.toolbox={},this.initStatus(),this.initMerger()}static isGroup(t){return t instanceof y||t instanceof x}initStatus(){this.exportCase=this.data.secure?this.$protection(this.case):this.case,this.status={created:!1}}initMerger(){for(let t in this.data.merger){let s=this.data.merger[t];!1===y.isGroup(s)&&this.$systemError("initMerger",`The '${t}' not a group.`)}}alone(t){return this.create(t),{tool:this.callTool.bind(this),line:this.callLine.bind(this)}}create(t){!1===this.status.created&&(this.data.create.bind(this.case)(t),this.status.created=!0)}getTool(t){if(this.toolbox[t])return this.toolbox[t];this.$systemError("getTool",`Tool(${t}) not found.`)}getLine(t){if(this.linebox[t])return this.linebox[t];this.$systemError("getLine",`Line(${t}) not found.`)}getMold(t){let s=this.moldbox[t]||f[t]||null;if(s)return s;this.$systemError("getMold",`Mold(${t}) not found.`)}getMerger(t){if(this.data.merger[t])return this.data.merger[t].alone();this.$systemError("getMerger",`Merger(${t}) not found.`)}callTool(t){return this.getTool(t).use()}callLine(t){return this.getLine(t).use()}addMold(t){let s=new m(t);this.$noKey("addMold",this.moldbox,s.name)&&(this.moldbox[s.name]=s)}addMolds(t){if(Array.isArray(t)){for(let s of t)this.addMold(s);return!0}if("object"==typeof t){for(let s in t)this.addTool({name:s,...t[s]});return!0}this.$systemError("addMolds","Molds not a array or object.",t)}addLine(t){let s=new d(t,this);this.$noKey("addLine",this.linebox,s.name)&&(this.linebox[s.name]=s)}addLines(t){if(Array.isArray(t)){for(let s of t)this.addLine(s);return!0}if("object"==typeof t){for(let s in t)this.addLine({name:s,...t[s]});return!0}this.$systemError("addLines","Lines not a array or object.",t)}addTool(t){let s=new c(t,this);this.$noKey("addTool",this.toolbox,s.name)&&(this.toolbox[s.name]=s)}addTools(t){if(Array.isArray(t)){for(let s of t)this.addTool(s);return!0}if("object"==typeof t){for(let s in t)this.addTool({name:s,...t[s]});return!0}this.$systemError("addTools","Tools not a array or object.",t)}hasTool(t){return!!this.toolbox[t]}hasLine(t){return!!this.linebox[t]}hasMold(t){return!!this.moldbox[t]}updateCall(t){this.getTool(t).update()}}class b{constructor(t){this.line=t.line.bind(t),this.tool=t.tool.bind(t),this.hasLine=t.hasLine.bind(t),this.hasTool=t.hasTool.bind(t),this.addGroup=t.addGroup.bind(t),this.hasGroup=t.hasGroup.bind(t),this.setBridge=t.setBridge.bind(t)}}class x{constructor(t){this.alone=t.alone.bind(t),this.create=t.create.bind(t),this.hasTool=t.hasTool.bind(t),this.hasMold=t.hasMold.bind(t),this.hasLine=t.hasLine.bind(t),this.addMold=t.addMold.bind(t),this.addLine=t.addLine.bind(t),this.addTool=t.addTool.bind(t),this.addMolds=t.addMolds.bind(t),this.addTools=t.addTools.bind(t),this.callTool=t.callTool.bind(t),this.callLine=t.callLine.bind(t)}}class ${constructor(t){this.has=t.has.bind(t),this.get=t.get.bind(t),this.list=t.list.bind(t),this.clear=t.clear.bind(t),this.create=t.create.bind(t),this.remove=t.remove.bind(t),this.getOrCreate=t.getOrCreate.bind(t)}}let w=i;return w.Group=y,w});